# 核心引擎：价格波动模型（更新版）

> 请将此内容替换原文档中的"## 四、 核心引擎：价格波动模型"整个章节（到"## 五、 做市商"之前）

---

## 四、 核心引擎：价格波动模型

### 模型一：$S_T$ (基本面价值 / 最终结算现货价)

这是基于供需基本面计算的"真实"价值。它由游戏"宏观经济"决定，并受到新闻事件的影响。

#### 1.1 基础公式

$$S_T = P_{\text{base}} \cdot \lambda_s \cdot \left( \frac{D_{\text{base}} + \sum_{i} \gamma(t,i) \cdot D_{\text{news}}(i)}{S_{\text{base}} + \sum_{i} \gamma(t,i) \cdot S_{\text{news}}(i)} \right)$$

#### 1.2 消化因子 $\gamma(t,i)$ 【新增】

新闻影响不再是一次性生效，而是通过**消化因子**逐步发挥作用，避免价格跳崖式变动：

**永久性新闻**（`is_permanent: true`，如开新店、害虫毁庄稼）：

| 条件 | $\gamma$ 值 | 说明 |
|------|------------|------|
| $t < t_i$ | 0 | 未发生 |
| $t_i \leq t < t_i + L$ | $(t - t_i + 1) / L$ | 消化中 |
| $t \geq t_i + L$ | 1 | 完全消化，影响**永久保持** |

**临时性新闻**（`is_permanent: false`，如节日促销）：

| 条件 | $\gamma$ 值 | 说明 |
|------|------------|------|
| $t < t_i$ | 0 | 未发生 |
| $t_i \leq t < t_i + L$ | $(t - t_i + 1) / L$ | 消化期：0→100% |
| $t_i + L \leq t < t_i + 2L$ | $1 - (t - t_i - L + 1) / L$ | 衰减期：100%→0 |
| $t \geq t_i + 2L$ | 0 | 过期消失 |

其中：
- $t_i$ = 新闻触发日
- $L$ = 持续天数（配置：`duration_days`）
- 临时性新闻的总有效期 = $2L$（消化期 + 衰减期）

#### 1.3 参数说明

| 符号 | 含义 | 配置参数 | 默认值 |
|------|------|----------|--------|
| $S_T$ | 基本面价值 | - | - |
| $P_{\text{base}}$ | 基础售价 | `base_price` | 35 |
| $\lambda_s$ | 季节乘数 | `off_season_multiplier` | 2.5（非当季） |
| $D_{\text{base}}$ | 基础需求 | `base_demand` | 100000 |
| $S_{\text{base}}$ | 基础供给 | `base_supply` | 100000 |
| $D_{\text{news}}$ | 需求变化 | `demand_delta` | - |
| $S_{\text{news}}$ | 供给变化 | `supply_delta` | - |

---

### 模型二：$S_t$ (每日现货价格的随机过程)

这是实现"随机波动"的核心。$S_t$（今天的现货价）是 $S_{t-1}$（昨天的现货价）的函数，并受到趋势惯性和随机冲击的影响。

#### 2.1 增强型 GBM 公式【已更新】

$$\ln(S_{t+1}) = \ln(S_t) + \underbrace{\alpha_t (\ln(Target) - \ln(S_t))}_{\text{均值回归}} + \underbrace{\mu \cdot r_{t-1}}_{\text{趋势惯性}} + \underbrace{\sigma_t \cdot \varepsilon_t}_{\text{随机波动}} + \underbrace{J_t}_{\text{跳跃}}$$

其中 $t \in \{1, 2, \dots, T-1\}$

#### 2.2 参数详解

**$\alpha_t$ (均值回归系数)：**

$$\alpha_t = \max\left(k, \frac{1}{T - t}\right)$$

- $k = 0.15$（配置：`mean_reversion_speed`）：最小回归速度，确保每天至少修复 15% 的价差
- $\frac{1}{T-t}$：交割日强制收敛逻辑
- **实现调整**：取两者较大值，确保既有市场化回归又有交割强制收敛

**$\mu$ (趋势惯性因子)：**【新增】
- 配置：`momentum_factor`（默认 0.3）
- $r_{t-1} = \ln(S_t) - \ln(S_{t-1})$：上一日收益率
- 值越大，价格越倾向于延续之前的趋势

**$\sigma_t$ (时变波动率)：**【已更新】

$$\sigma_t = \sigma_{base} \cdot \Phi_t \cdot \sqrt{\frac{T - t}{T}}$$

- $\sigma_{base}$（配置：`base_volatility`，默认 0.02）
- $\Phi_t$ = GARCH 波动率状态（见下文）
- 平方根衰减：离交割越近，波动越小
- $T = 28$（季节总天数）

**$\Phi_t$ (波动率聚集 / GARCH 效应)：**【新增】

$$\Phi_{t+1} = \beta \cdot \Phi_t + (1-\beta) \cdot \frac{|r_t|}{\sigma_{base}}$$

- $\beta$（配置：`volatility_clustering`，默认 0.6）
- 范围限制：$\Phi_t \in [0.5, 2.5]$
- **含义**：昨天波动大 → 今天也容易波动大（市场恐慌/兴奋会持续几天）

**$J_t$ (跳跃项)：**【新增】

$$J_t = \begin{cases}
\pm J_{mag} & \text{概率 } p_{jump} \\
0 & \text{概率 } 1 - p_{jump}
\end{cases}$$

- $p_{jump}$（配置：`jump_probability`，默认 0.01）
- $J_{mag}$（配置：`jump_magnitude`，默认 0.03）
- 方向随机（± 50%）

**$\varepsilon_t$：** 标准正态随机数 $\sim N(0,1)$

#### 2.3 配置参数汇总

| 参数 | 配置键 | 默认值 | 说明 |
|------|--------|--------|------|
| 基础波动率 | `base_volatility` | 0.02 | 日波动率标准差 |
| 均值回归速度 | `mean_reversion_speed` | 0.15 | 每日最小回归比例 |
| 趋势惯性 | `momentum_factor` | 0.3 | 价格趋势延续程度 |
| 波动率聚集 | `volatility_clustering` | 0.6 | GARCH 效应强度 |
| 跳跃概率 | `jump_probability` | 0.01 | 每日跳空概率 |
| 跳跃幅度 | `jump_magnitude` | 0.03 | 跳空时的价格变动 |

---

### 模型三：$F_t$ (每日期货价格 - 持有成本模型)

这是玩家*实际交易*的期货合约价格。它严格遵守金融的**持有成本 (Cost-of-Carry) 套利模型**。

#### 3.1 公式【已更新为年化处理】

$$F_t = S_t \cdot e^{(r + \phi - q) \cdot \tau}$$

其中 $\tau = \frac{T - t}{112}$ 为到期时间的年化比例（112 = 4季节 × 28天）

#### 3.2 参数说明

| 符号 | 含义 | 配置参数 | 默认值 |
|------|------|----------|--------|
| $F_t$ | 期货合约价格 | - | - |
| $S_t$ | 现货价格（由模型二给出） | - | - |
| $(T - t)$ | 距离交割日的天数 | - | - |
| $r$ | 年化无风险利率 | `risk_free_rate` | 0.08 (8%) |
| $\phi$ | 年化仓储成本 | `storage_cost` | 0.56 (日化0.005×112) |
| $q$ | 年化便利收益率 | `base_convenience_yield` | 0.03 (3%) |

**事件便利收益加成：**

| 事件 | 加成 |
|------|------|
| NPC 生日 | +10% |
| 社区中心收集 | +5% |
| 节日需求 | +3% |

#### 3.3 基差分析

$$\text{Basis} = F_t - S_t$$

- **正基差（Contango）：** 期货 > 现货，正常市场（持有成本 > 便利收益）
- **负基差（Backwardation）：** 期货 < 现货，稀缺市场（便利收益 > 持有成本）

---

### 模型四：$P(\tau)$ (日内微观结构 - 布朗桥)

本模型采用**布朗桥 (Brownian Bridge)** 过程，模拟价格在日内交易中的随机游走及其向目标价位的收敛特性。

#### 4.1 核心演化方程

每一帧（Tick）的价格 $P_{\tau+1}$ 由"上一帧价格"、"回归引力"和"动态噪音"三部分组成：

$$P_{\tau+1} = P_{\tau} + \underbrace{\frac{P_{target} - P_{\tau}}{T_{remain}}}_{\text{回归引力 (Gravity)}} + \underbrace{\sigma_{intra} \cdot \Psi(\tau) \cdot \varepsilon}_{\text{动态噪音 (Dynamic Noise)}}$$

#### 4.2 参数说明

| 符号 | 含义 | 配置参数 | 默认值 |
|------|------|----------|--------|
| $\tau$ | 当前 Tick 指针 | - | - |
| $P_{\tau}$ | 当前价格 | - | - |
| $T_{remain}$ | 距收盘剩余 Tick 数 | - | - |
| $\sigma_{intra}$ | 日内波动率 | `intraday_volatility` | 0.01 |
| $\varepsilon$ | 标准正态随机数 | - | - |

> **收敛逻辑：** $T_{remain}$ 作为分母，当 $T_{remain} \to 0$ 时，引力趋于无穷大，强制价格精准收敛于 $P_{target}$。

#### 4.3 波动率微笑因子 $\Psi(\tau)$【已实现】

$$\Psi(\tau) = \underbrace{(1 + \alpha \cdot e^{-\lambda \cdot \tau_{elapsed}})}_{\text{开盘活跃衰减}} \cdot \underbrace{\sqrt{\frac{T_{remain}}{T_{total}}}}_{\text{收盘收敛包络}}$$

| 参数 | 值 | 说明 |
|------|-----|------|
| $\alpha$ | 2.0 | 开盘活跃度提升系数 |
| $\lambda$ | 10.0 | 衰减速率 |
| $\tau_{elapsed}$ | $1 - T_{remain}/T_{total}$ | 已进行时间比例 |

**视觉效果：**
- **开盘：** 波动率极高（消化隔夜情绪）
- **盘中：** 波动率逐渐平稳
- **收盘：** 波动率归零，曲线闭合

#### 4.4 事件驱动机制 (Event-Driven)

当 $t$ 时刻发生突发新闻时，系统将按以下逻辑动态更新：

1. **触发 (Trigger):** 宏观模型计算出全新的目标价 $P_{target}$。
2. **重置 (Reset):**
   - **操作:** 仅需更新 $P_{target} \leftarrow S'_{t+1}$。
   - **优势:** **无需**重置 $\tau$ 或 $P_{start}$，无需复杂回溯。
3. **效果 (Effect):**
   - 下一帧计算时，公式中的 $(P_{target} - P_{\tau})$ 差值瞬间变大。
   - "回归引力"项自动调整方向和力度。
   - **结果:** 价格如同被磁铁吸附一般，自然地（而非生硬地）转向新目标，算法复杂度保持为 $O(1)$。

#### 4.5 特殊机制：尾盘熔断与隔夜跳空

**(The Overnight Gap)**

为了解决"尾盘发生大新闻导致 K 线垂直崩盘"的问题，引入熔断机制。

当满足以下两个条件时触发：

1. **时间紧迫:** $T_{remain} < T_{threshold}$ (例如：最后 10% 的 ticks)。
2. **跌幅过大:** $|P_{target} - P_{\tau}| > \text{MaxMove}$ (例如：5%)。

**熔断处理流程：**

1. **日内锁定:** 强制设定当日收盘目标：
   $$P_{close\_today} = P_{\tau} \pm \text{MaxMove}$$

2. **压力转移:** 将未消化的价差计入"隔夜情绪池"：
   $$\text{Gap} = P_{target} - P_{close\_today}$$

3. **次日开盘:**
   $$O_{t+1} = S_{t+1} + \text{Gap}$$

> **玩家体验优化:** 如果半夜突发大利空，当晚价格会呈现"跌停"状态；第二天早上会直接大幅低开。这完美复刻了真实金融市场的"盘后消息消化"与"跳空开盘"机制。

---

> **以上内容用于替换原文档"## 四、 核心引擎：价格波动模型"章节**

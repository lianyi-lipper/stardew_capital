<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Capital - Price Viewer v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        select {
            padding: 12px 20px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.3s;
        }

        select:hover {
            border-color: #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .intraday-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .intraday-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .intraday-controls label {
            font-weight: bold;
            color: #2d3748;
        }

        .params-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .params-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .param-item {
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .param-label {
            font-size: 0.85em;
            color: #718096;
        }

        .param-value {
            font-weight: bold;
            color: #2d3748;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .news-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .news-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .news-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            border-radius: 8px;
        }

        .news-item.critical {
            border-left-color: #e53e3e;
            background: #fff5f5;
        }

        .news-item.high {
            border-left-color: #dd6b20;
            background: #fffaf0;
        }

        .news-item.medium {
            border-left-color: #d69e2e;
        }

        .news-item.low {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .news-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .news-meta {
            font-size: 0.85em;
            color: #718096;
            margin-bottom: 8px;
        }

        .news-impact {
            font-size: 0.9em;
            color: #4a5568;
        }

        .impact-positive {
            color: #48bb78;
        }

        .impact-negative {
            color: #f56565;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìà Stardew Capital Price Viewer v2</h1>
        <p class="subtitle">ÂèØËßÜÂåñÊúüË¥ß‰ª∑Ê†ºËµ∞Âäø (ÈÄÇÈÖç SeasonSimulationOutput Ê†ºÂºè)</p>

        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".json">
            </div>
            <select id="commoditySelect" disabled>
                <option value="">ÈÄâÊã©ÂïÜÂìÅ...</option>
            </select>
        </div>

        <div id="errorMessage"></div>
        <div id="infoSection"></div>
        <div id="paramsSection"></div>

        <!-- Êó•Êî∂Áõò‰ª∑ÂõæË°® -->
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>

        <!-- Êó•ÂÜÖ‰ª∑Ê†ºËµ∞ÂäøÂõæË°® -->
        <div class="intraday-section" id="intradaySection" style="display: none;">
            <div class="intraday-controls">
                <label for="daySelect">üìä ÈÄâÊã©Êó•ÊúüÊü•ÁúãÊó•ÂÜÖ‰ª∑Ê†ºËµ∞ÂäøÔºö</label>
                <select id="daySelect">
                    <option value="">ËØ∑ÂÖàÈÄâÊã©ÂïÜÂìÅ</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="intradayChart"></canvas>
            </div>
        </div>

        <!-- Êñ∞Èóª‰∫ã‰ª∂ÂàóË°® -->
        <div class="news-section" id="newsSection" style="display: none;"></div>
    </div>

    <script>
        let simulationData = null;
        let chart = null;
        let intradayChart = null;
        let currentCommodity = null;

        const fileInput = document.getElementById('fileInput');
        const commoditySelect = document.getElementById('commoditySelect');
        const errorMessage = document.getElementById('errorMessage');
        const infoSection = document.getElementById('infoSection');
        const paramsSection = document.getElementById('paramsSection');
        const daySelect = document.getElementById('daySelect');
        const intradaySection = document.getElementById('intradaySection');

        fileInput.addEventListener('change', handleFileSelect);
        commoditySelect.addEventListener('change', handleCommoditySelect);
        daySelect.addEventListener('change', handleDaySelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    simulationData = JSON.parse(e.target.result);
                    loadCommodities();
                    displayParameters();
                    displayNews();
                    errorMessage.innerHTML = '';
                } catch (error) {
                    showError('JSON Ëß£ÊûêÂ§±Ë¥•: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadCommodities() {
            commoditySelect.innerHTML = '<option value="">ÈÄâÊã©ÂïÜÂìÅ...</option>';

            if (simulationData.commodityResults) {
                Object.keys(simulationData.commodityResults).forEach(symbol => {
                    const commodity = simulationData.commodityResults[symbol];
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${commodity.commodityName} (${symbol})`;
                    commoditySelect.appendChild(option);
                });
                commoditySelect.disabled = false;
            }
        }

        function displayParameters() {
            if (!simulationData.parameters) {
                paramsSection.innerHTML = '';
                return;
            }

            const params = simulationData.parameters;
            paramsSection.innerHTML = `
                <div class="params-section">
                    <h2>‚öôÔ∏è Ê®°ÊãüÂèÇÊï∞</h2>
                    <div class="params-grid">
                        <div class="param-item">
                            <div class="param-label">Êó†È£éÈô©Âà©Áéá</div>
                            <div class="param-value">${(params.riskFreeRate * 100).toFixed(2)}%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Â≠òÂÇ®ÊàêÊú¨</div>
                            <div class="param-value">${(params.storageCost * 100).toFixed(2)}%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">‰æøÂà©Êî∂Áõä</div>
                            <div class="param-value">${(params.convenienceYield * 100).toFixed(2)}%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Êó•Èó¥Ê≥¢Âä®Áéá</div>
                            <div class="param-value">${(params.baseVolatility * 100).toFixed(1)}%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Êó•ÂÜÖÊ≥¢Âä®Áéá</div>
                            <div class="param-value">${(params.intradayVolatility * 100).toFixed(2)}%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleCommoditySelect() {
            const selectedSymbol = commoditySelect.value;
            if (selectedSymbol === '') return;

            currentCommodity = simulationData.commodityResults[selectedSymbol];
            currentCommodity.symbol = selectedSymbol;
            displayMarketInfo(currentCommodity);
            displayChart(currentCommodity);
            initializeDaySelect(currentCommodity);
        }

        function displayMarketInfo(commodity) {
            const dailyData = commodity.dailyData || [];
            const openPrice = dailyData.length > 0 ? dailyData[0].openPrice : 0;
            const closePrice = dailyData.length > 0 ? dailyData[dailyData.length - 1].closePrice : 0;
            const allHighs = dailyData.map(d => d.highPrice);
            const allLows = dailyData.map(d => d.lowPrice);
            const maxPrice = Math.max(...allHighs);
            const minPrice = Math.min(...allLows);
            const priceChange = ((closePrice - openPrice) / openPrice * 100).toFixed(2);
            const priceChangeColor = priceChange >= 0 ? '#48bb78' : '#f56565';

            infoSection.innerHTML = `
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">ÂïÜÂìÅÂêçÁß∞</div>
                        <div class="info-value">${commodity.commodityName}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Â≠£ËäÇ</div>
                        <div class="info-value">${simulationData.season}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">ÊÄªÂ§©Êï∞</div>
                        <div class="info-value">${simulationData.totalDays}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Âü∫Á°Ä‰ª∑Ê†º</div>
                        <div class="info-value">${commodity.basePrice}g</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Â≠£Â∫¶Ê∂®Ë∑å</div>
                        <div class="info-value" style="color: ${priceChangeColor}">${priceChange > 0 ? '+' : ''}${priceChange}%</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">‰ª∑Ê†ºÂå∫Èó¥</div>
                        <div class="info-value">${minPrice.toFixed(1)} - ${maxPrice.toFixed(1)}g</div>
                    </div>
                </div>
            `;
        }

        function displayChart(commodity) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            const dailyData = commodity.dailyData || [];

            const labels = dailyData.map(d => `Day ${d.day}`);
            const closePrices = dailyData.map(d => d.closePrice);
            const openPrices = dailyData.map(d => d.openPrice);
            const fundamentalValues = dailyData.map(d => d.fundamentalValue);

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Êî∂Áõò‰ª∑',
                            data: closePrices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'ÂºÄÁõò‰ª∑',
                            data: openPrices,
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 2,
                            hidden: true
                        },
                        {
                            label: 'Âü∫Êú¨Èù¢‰ª∑ÂÄº',
                            data: fundamentalValues,
                            borderColor: '#f56565',
                            backgroundColor: 'rgba(245, 101, 101, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${commodity.commodityName} ‰ª∑Ê†ºËµ∞Âäø (${simulationData.season})`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterBody: function (context) {
                                    const dayIndex = context[0].dataIndex;
                                    const day = dailyData[dayIndex];
                                    return [
                                        `ÊúÄÈ´ò: ${day.highPrice.toFixed(2)}g`,
                                        `ÊúÄ‰Ωé: ${day.lowPrice.toFixed(2)}g`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '‰ª∑Ê†º (g)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ê∏∏ÊàèÊó•Êúü'
                            }
                        }
                    }
                }
            });
        }

        function initializeDaySelect(commodity) {
            const dailyData = commodity.dailyData || [];

            daySelect.innerHTML = '<option value="">ÈÄâÊã©Ë¶ÅÊü•ÁúãÁöÑÊó•Êúü...</option>';

            dailyData.forEach((day, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Day ${day.day}`;
                daySelect.appendChild(option);
            });

            intradaySection.style.display = 'block';
        }

        function handleDaySelect() {
            const selectedIndex = parseInt(daySelect.value);
            if (isNaN(selectedIndex) || !currentCommodity) return;

            displayIntradayChart(currentCommodity, selectedIndex);
        }

        function displayIntradayChart(commodity, dayIndex) {
            const ctx = document.getElementById('intradayChart').getContext('2d');
            const dailyData = commodity.dailyData || [];
            const day = dailyData[dayIndex];

            if (!day || !day.intradayPrices) {
                showError('ËØ•Êó•ÊúüÊ≤°ÊúâÊó•ÂÜÖ‰ª∑Ê†ºÊï∞ÊçÆ');
                return;
            }

            const intradayPrices = day.intradayPrices;
            const labels = intradayPrices.map(p => p.time);
            const shadowPrices = intradayPrices.map(p => p.shadowPrice);
            const targetPrices = intradayPrices.map(p => p.targetPrice);

            if (intradayChart) {
                intradayChart.destroy();
            }

            intradayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ÂΩ±Â≠ê‰ª∑Ê†º',
                            data: shadowPrices,
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            fill: true
                        },
                        {
                            label: 'ÁõÆÊ†á‰ª∑Ê†º',
                            data: targetPrices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            tension: 0.3,
                            pointRadius: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Day ${day.day} - ${commodity.commodityName} Êó•ÂÜÖ‰ª∑Ê†ºËµ∞Âäø`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterBody: function (context) {
                                    const index = context[0].dataIndex;
                                    const impact = intradayPrices[index].marketImpact;
                                    if (Math.abs(impact) > 0.01) {
                                        return [`Â∏ÇÂú∫ÂÜ≤Âáª: ${impact.toFixed(3)}`];
                                    }
                                    return [];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '‰ª∑Ê†º (g)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Êó∂Èó¥'
                            },
                            ticks: {
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });
        }

        function showError(message) {
            errorMessage.innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        function displayNews() {
            const newsSection = document.getElementById('newsSection');
            const newsEvents = simulationData.newsEvents || [];

            if (newsEvents.length === 0) {
                newsSection.style.display = 'none';
                return;
            }

            newsSection.style.display = 'block';

            let newsHTML = `<h2>üì∞ Êñ∞Èóª‰∫ã‰ª∂ (${newsEvents.length})</h2>`;

            newsEvents.forEach(news => {
                const impact = news.impact || {};
                const demandDelta = impact.demandDelta || 0;
                const supplyDelta = impact.supplyDelta || 0;
                const priceMultiplier = impact.priceMultiplier || 1.0;

                // ËÆ°ÁÆóÂáÄÂΩ±ÂìçÔºàÈúÄÊ±ÇÂ¢ûÂä†Êàñ‰æõÁªôÂáèÂ∞ëÈÉΩÊòØÂà©Â•ΩÔºâ
                const netImpact = demandDelta - supplyDelta;

                const severityClass = news.severity?.toLowerCase() || 'medium';
                const demandClass = demandDelta > 0 ? 'impact-positive' : (demandDelta < 0 ? 'impact-negative' : '');
                const supplyClass = supplyDelta < 0 ? 'impact-positive' : (supplyDelta > 0 ? 'impact-negative' : '');
                const netClass = netImpact > 0 ? 'impact-positive' : (netImpact < 0 ? 'impact-negative' : '');

                let priceMultiplierText = '';
                if (priceMultiplier !== 1.0) {
                    const pctChange = ((priceMultiplier - 1) * 100).toFixed(1);
                    const sign = priceMultiplier > 1 ? '+' : '';
                    priceMultiplierText = ` | Âç≥Êó∂ÂÜ≤Âáª: <span class="${priceMultiplier > 1 ? 'impact-positive' : 'impact-negative'}">${sign}${pctChange}%</span>`;
                }

                newsHTML += `
                    <div class="news-item ${severityClass}">
                        <div class="news-title">üì∞ ${news.title}</div>
                        <div class="news-meta">
                            Day ${news.triggerDay} ${news.triggerTime || '06:00'} | ÊåÅÁª≠ ${news.durationDays} Â§© | 
                            ‰∏•ÈáçÂ∫¶: <strong>${news.severity}</strong>
                        </div>
                        <div class="news-impact">
                            ÈúÄÊ±ÇÂΩ±Âìç: <span class="${demandClass}">${demandDelta > 0 ? '+' : ''}${demandDelta}</span> | 
                            ‰æõÁªôÂΩ±Âìç: <span class="${supplyClass}">${supplyDelta > 0 ? '+' : ''}${supplyDelta}</span> | 
                            ÂáÄÂΩ±Âìç: <span class="${netClass}">${netImpact > 0 ? '+' : ''}${netImpact.toFixed(0)}</span>
                            ${priceMultiplierText}
                        </div>
                    </div>
                `;
            });

            newsSection.innerHTML = newsHTML;
        }
    </script>
</body>

</html>
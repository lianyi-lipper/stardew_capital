# 《星露资本-期货部分》Mod：完整设计总纲

## 一、 核心概念与目标

- **目标**：在《星露谷物语》中引入一个高真实度的商品期货市场，让玩家（农场主）能够：
  1. **管理风险（套期保值）**：锁定未来农作物的售价，对抗市场波动。
  2. **方向投机（杠杆交易）**：利用保证金杠杆，对未来价格进行方向性押注。
  3. **高级套利（期现联动）**：利用期货与现货之间的价差（基差）进行套利。

## 二、 核心游戏循环

1. **套期保值（Hedge）**：
   - **场景**：春季第1天，玩家种下1000个防风草。此时期货价格（$P_{\text{future}}$）为40g。玩家担心季末价格暴跌。
   - **操作**：玩家“卖出开仓”10手“春季防风草-28天合约”，锁定40g的卖价。
   - **结果 (Day 28)**：
     - **A. 价格暴跌**：现货价（$P_{\text{spot}}$）跌至20g。玩家现货少赚了20g/个。但期货合约盈利 (40g-20g) x 1000，完美弥补了亏损。
     - **B. 价格暴涨**：现货价（$P_{\text{spot}}$）涨至60g。玩家现货多赚了20g/个。但期货合约亏损 (40g-60g) x 1000，抵消了超额收益。
   - **最终效果**：无论价格如何，玩家的总收入都被锁定在40g/个，实现了风险管理。
2. **投机 (Speculate)**：
   - 玩家预期“害虫危机”会导致价格上涨。他只需支付10%的保证金（例如4g/个），就能“买入开仓”10手合约。如果价格如期上涨到60g，他将获得巨额杠杆回报。如果价格下跌，他可能血本无归（强制平仓）。
3. **期现套利 (Arbitrage)**：
   - 玩家发现 $P_{\text{future}}$ (40g) 远高于 $P_{\text{spot}}$ (35g) + 持有成本 (1g)。他会立刻“买入现货”（35g），同时“卖出期货”（40g），锁定4g的无风险利润。这种行为会（通过我们设计的“价格冲击”机制）反过来把价差拉回合理水平。

## 三、 核心机制：实物交割与风险

- **合约**：标准化的（例如“春季防风草-28天合约”，1手 = 100个）。
- **保证金**：交易采用保证金制度，高杠杆与高风险并存。
- **每日结算**：根据当日收盘价结算持仓盈亏，保证金不足会收到“追保通知”，未及时补足则“强制平仓”。
- **实物交割（Day 28）**：
  - **玩家持有多单（Long）**：合约到期，系统自动通过邮件向玩家发送100个/手防风草。
  - **玩家持有空单（Short）**：合约到期，系统检查玩家库存（或指定交割箱）。
  - **空单违约**：如果玩家未能足额交付100个/手的防风草，将视为“违约”，**没收其全部保证金**作为惩罚。这是除强平外的最严厉惩罚。



## 四、 核心引擎：价格波动模型

### 模型一：$S_T$ (基本面价值 / 最终结算现货价)

这是基于供需基本面计算的"真实"价值。它由游戏"宏观经济"决定，并受到新闻事件的影响。

#### 1.1 基础公式

$$S_T = P_{\text{base}} \cdot \lambda_s \cdot \left( \frac{D_{\text{base}} + \sum_{i} \gamma(t,i) \cdot D_{\text{news}}(i)}{S_{\text{base}} + \sum_{i} \gamma(t,i) \cdot S_{\text{news}}(i)} \right)$$

#### 1.2 消化因子 $\gamma(t,i)$ 

新闻影响不再是一次性生效，而是通过**消化因子**逐步发挥作用，避免价格跳崖式变动：

**永久性新闻**（`is_permanent: true`，如开新店、害虫毁庄稼）：

| 条件 | $\gamma$ 值 | 说明 |
|------|------------|------|
| $t < t_i$ | 0 | 未发生 |
| $t_i \leq t < t_i + L$ | $(t - t_i + 1) / L$ | 消化中 |
| $t \geq t_i + L$ | 1 | 完全消化，影响**永久保持** |

**临时性新闻**（`is_permanent: false`，如节日促销）：

| 条件 | $\gamma$ 值 | 说明 |
|------|------------|------|
| $t < t_i$ | 0 | 未发生 |
| $t_i \leq t < t_i + L$ | $(t - t_i + 1) / L$ | 消化期：0→100% |
| $t_i + L \leq t < t_i + 2L$ | $1 - (t - t_i - L + 1) / L$ | 衰减期：100%→0 |
| $t \geq t_i + 2L$ | 0 | 过期消失 |

其中：
- $t_i$ = 新闻触发日
- $L$ = 持续天数（配置：`duration_days`）
- 临时性新闻的总有效期 = $2L$（消化期 + 衰减期）

#### 1.3 参数说明

| 符号 | 含义 | 配置参数 | 默认值 |
|------|------|----------|--------|
| $S_T$ | 基本面价值 | - | - |
| $P_{\text{base}}$ | 基础售价 | `base_price` | 35 |
| $\lambda_s$ | 季节乘数 | `off_season_multiplier` | 2.5（非当季） |
| $D_{\text{base}}$ | 基础需求 | `base_demand` | 100000 |
| $S_{\text{base}}$ | 基础供给 | `base_supply` | 100000 |
| $D_{\text{news}}$ | 需求变化 | `demand_delta` | - |
| $S_{\text{news}}$ | 供给变化 | `supply_delta` | - |

---

### 模型二：$S_t$ (每日现货价格的随机过程)

这是实现"随机波动"的核心。$S_t$（今天的现货价）是 $S_{t-1}$（昨天的现货价）的函数，并受到趋势惯性和随机冲击的影响。

#### 2.1 增强型 GBM 公式【已更新】

$$\ln(S_{t+1}) = \ln(S_t) + \underbrace{\alpha_t (\ln(Target) - \ln(S_t))}_{\text{均值回归}} + \underbrace{\mu \cdot r_{t-1}}_{\text{趋势惯性}} + \underbrace{\sigma_t \cdot \varepsilon_t}_{\text{随机波动}} + \underbrace{J_t}_{\text{跳跃}}$$

其中 $t \in \{1, 2, \dots, T-1\}$

#### 2.2 参数详解

**$\alpha_t$ (均值回归系数)：**

$$\alpha_t = \max\left(k, \frac{1}{T - t}\right)$$

- $k = 0.15$（配置：`mean_reversion_speed`）：最小回归速度，确保每天至少修复 15% 的价差
- $\frac{1}{T-t}$：交割日强制收敛逻辑
- **实现调整**：取两者较大值，确保既有市场化回归又有交割强制收敛

**$\mu$ (趋势惯性因子)：**【新增】
- 配置：`momentum_factor`（默认 0.3）
- $r_{t-1} = \ln(S_t) - \ln(S_{t-1})$：上一日收益率
- 值越大，价格越倾向于延续之前的趋势

**$\sigma_t$ (时变波动率)：**【已更新】

$$\sigma_t = \sigma_{base} \cdot \Phi_t \cdot \sqrt{\frac{T - t}{T}}$$

- $\sigma_{base}$（配置：`base_volatility`，默认 0.02）
- $\Phi_t$ = GARCH 波动率状态（见下文）
- 平方根衰减：离交割越近，波动越小
- $T = 28$（季节总天数）

**$\Phi_t$ (波动率聚集 / GARCH 效应)：**【新增】

$$\Phi_{t+1} = \beta \cdot \Phi_t + (1-\beta) \cdot \frac{|r_t|}{\sigma_{base}}$$

- $\beta$（配置：`volatility_clustering`，默认 0.6）
- 范围限制：$\Phi_t \in [0.5, 2.5]$
- **含义**：昨天波动大 → 今天也容易波动大（市场恐慌/兴奋会持续几天）

**$J_t$ (跳跃项)：**【新增】

$$J_t = \begin{cases}
\pm J_{mag} & \text{概率 } p_{jump} \\
0 & \text{概率 } 1 - p_{jump}
\end{cases}$$

- $p_{jump}$（配置：`jump_probability`，默认 0.01）
- $J_{mag}$（配置：`jump_magnitude`，默认 0.03）
- 方向随机（± 50%）

**$\varepsilon_t$：** 标准正态随机数 $\sim N(0,1)$

#### 2.3 配置参数汇总

| 参数 | 配置键 | 默认值 | 说明 |
|------|--------|--------|------|
| 基础波动率 | `base_volatility` | 0.02 | 日波动率标准差 |
| 均值回归速度 | `mean_reversion_speed` | 0.15 | 每日最小回归比例 |
| 趋势惯性 | `momentum_factor` | 0.3 | 价格趋势延续程度 |
| 波动率聚集 | `volatility_clustering` | 0.6 | GARCH 效应强度 |
| 跳跃概率 | `jump_probability` | 0.01 | 每日跳空概率 |
| 跳跃幅度 | `jump_magnitude` | 0.03 | 跳空时的价格变动 |

---

### 模型三：$F_t$ (每日期货价格 - 持有成本模型)

这是玩家*实际交易*的期货合约价格。它严格遵守金融的**持有成本 (Cost-of-Carry) 套利模型**。

#### 3.1 公式【已更新为年化处理】

$$F_t = S_t \cdot e^{(r + \phi - q) \cdot \tau}$$

其中 $\tau = \frac{T - t}{112}$ 为到期时间的年化比例（112 = 4季节 × 28天）

#### 3.2 参数说明

| 符号 | 含义 | 配置参数 | 默认值 |
|------|------|----------|--------|
| $F_t$ | 期货合约价格 | - | - |
| $S_t$ | 现货价格（由模型二给出） | - | - |
| $(T - t)$ | 距离交割日的天数 | - | - |
| $r$ | 年化无风险利率 | `risk_free_rate` | 0.08 (8%) |
| $\phi$ | 年化仓储成本 | `storage_cost` | 0.56 (日化0.005×112) |
| $q$ | 年化便利收益率 | `base_convenience_yield` | 0.03 (3%) |

**事件便利收益加成：**

| 事件 | 加成 |
|------|------|
| NPC 生日 | +10% |
| 社区中心收集 | +5% |
| 节日需求 | +3% |

#### 3.3 基差分析

$$\text{Basis} = F_t - S_t$$

- **正基差（Contango）：** 期货 > 现货，正常市场（持有成本 > 便利收益）
- **负基差（Backwardation）：** 期货 < 现货，稀缺市场（便利收益 > 持有成本）

---

### 模型四：$P(\tau)$ (日内微观结构 - 布朗桥)

本模型采用**布朗桥 (Brownian Bridge)** 过程，模拟价格在日内交易中的随机游走及其向目标价位的收敛特性。

#### 4.1 核心演化方程

每一帧（Tick）的价格 $P_{\tau+1}$ 由"上一帧价格"、"回归引力"和"动态噪音"三部分组成：

$$P_{\tau+1} = P_{\tau} + \underbrace{\frac{P_{target} - P_{\tau}}{T_{remain}}}_{\text{回归引力 (Gravity)}} + \underbrace{\sigma_{intra} \cdot \Psi(\tau) \cdot \varepsilon}_{\text{动态噪音 (Dynamic Noise)}}$$

#### 4.2 参数说明

| 符号 | 含义 | 配置参数 | 默认值 |
|------|------|----------|--------|
| $\tau$ | 当前 Tick 指针 | - | - |
| $P_{\tau}$ | 当前价格 | - | - |
| $T_{remain}$ | 距收盘剩余 Tick 数 | - | - |
| $\sigma_{intra}$ | 日内波动率 | `intraday_volatility` | 0.01 |
| $\varepsilon$ | 标准正态随机数 | - | - |

> **收敛逻辑：** $T_{remain}$ 作为分母，当 $T_{remain} \to 0$ 时，引力趋于无穷大，强制价格精准收敛于 $P_{target}$。

#### 4.3 波动率微笑因子 $\Psi(\tau)$【已实现】

$$\Psi(\tau) = \underbrace{(1 + \alpha \cdot e^{-\lambda \cdot \tau_{elapsed}})}_{\text{开盘活跃衰减}} \cdot \underbrace{\sqrt{\frac{T_{remain}}{T_{total}}}}_{\text{收盘收敛包络}}$$

| 参数 | 值 | 说明 |
|------|-----|------|
| $\alpha$ | 2.0 | 开盘活跃度提升系数 |
| $\lambda$ | 10.0 | 衰减速率 |
| $\tau_{elapsed}$ | $1 - T_{remain}/T_{total}$ | 已进行时间比例 |

**视觉效果：**
- **开盘：** 波动率极高（消化隔夜情绪）
- **盘中：** 波动率逐渐平稳
- **收盘：** 波动率归零，曲线闭合

#### 4.4 事件驱动机制 (Event-Driven)

当 $t$ 时刻发生突发新闻时，系统将按以下逻辑动态更新：

1. **触发 (Trigger):** 宏观模型计算出全新的目标价 $P_{target}$。
2. **重置 (Reset):**
   - **操作:** 仅需更新 $P_{target} \leftarrow S'_{t+1}$。
   - **优势:** **无需**重置 $\tau$ 或 $P_{start}$，无需复杂回溯。
3. **效果 (Effect):**
   - 下一帧计算时，公式中的 $(P_{target} - P_{\tau})$ 差值瞬间变大。
   - "回归引力"项自动调整方向和力度。
   - **结果:** 价格如同被磁铁吸附一般，自然地（而非生硬地）转向新目标，算法复杂度保持为 $O(1)$。

#### 4.5 特殊机制：尾盘熔断与隔夜跳空

**(The Overnight Gap)**

为了解决"尾盘发生大新闻导致 K 线垂直崩盘"的问题，引入熔断机制。

当满足以下两个条件时触发：

1. **时间紧迫:** $T_{remain} < T_{threshold}$ (例如：最后 10% 的 ticks)。
2. **跌幅过大:** $|P_{target} - P_{\tau}| > \text{MaxMove}$ (例如：5%)。

**熔断处理流程：**

1. **日内锁定:** 强制设定当日收盘目标：
   $$P_{close\_today} = P_{\tau} \pm \text{MaxMove}$$

2. **压力转移:** 将未消化的价差计入"隔夜情绪池"：
   $$\text{Gap} = P_{target} - P_{close\_today}$$

3. **次日开盘:**
   $$O_{t+1} = S_{t+1} + \text{Gap}$$

> **玩家体验优化:** 如果半夜突发大利空，当晚价格会呈现"跌停"状态；第二天早上会直接大幅低开。这完美复刻了真实金融市场的"盘后消息消化"与"跳空开盘"机制。

---

### 模型五：$I(t)$ (市场微观博弈与冲击层 - 独立叠加系统)

这是赋予市场“人性”与“混乱”的灵魂层。

它独立于之前的宏观与日内模型，作为一个**“影子价格 (Shadow Price)”**叠加在理性的**基准价格**之上。

#### 1. 核心叠加公式

最终玩家在交易所看到的、用于成交的价格 $P_{Final}(t)$ 由两部分组成：

$$P_{Final}(t) = P_{Model}(t) + I(t)$$

- **$P_{Model}(t)$ (理性基准):** 由模型一至模型四计算出的、基于基本面和布朗桥的“上帝视角合理价”。
- **$I(t)$ (市场冲击/情绪溢价):** 由玩家交易、NPC跟风、恐慌或贪婪造成的“价格泡沫”或“洼地”。

#### 2. 冲击演化方程 (The Evolution of Chaos)

冲击值 $I(t)$ 不是静态的，它是一个动态变化的博弈结果。下一帧的冲击值 $I(t+1)$ 取决于当前的残留冲击、玩家的新操作以及三类NPC的反应：

$$I(t+1) = I(t) + \underbrace{\Delta I_{Player}}_{\text{点火}} + \underbrace{\Delta I_{Smart}}_{\text{回归}} + \underbrace{\Delta I_{Trend}}_{\text{趋势}} + \underbrace{\Delta I_{FOMO}}_{\text{情绪}}$$

### 3. 市场参与者画像 (The Participants)

我们将NPC抽象为三股互相拉扯的数学力量。它们的强度由**当前的市场剧本**（见第4节）决定。

##### A. $\Delta I_{Player}$ (玩家：点火者)

含义: 玩家的大额订单对流动性池造成的直接物理冲击。

公式:

$$\Delta I_{Player} = Q_{trade} \cdot \eta$$

- $Q_{trade}$: 玩家交易量（正为买，负为卖）。
- $\eta$ (流动性敏感度): 市场的深浅。大城市 $\eta$ 极小，鹈鹕镇 $\eta$ 较大。
- **逻辑:** 玩家是第一块投入湖面的石头，激起最初的涟漪。

##### B. $\Delta I_{Smart}$ (聪明钱：价值回归者)

含义: 理性的套利者（如皮埃尔、乔治）。他们只信奉模型一算出的“真相” $S_T$。

公式:

$$\Delta I_{Smart} = k_{smart} \cdot (S_T - P_{Final}(t))$$

- $k_{smart}$: 回归系数。
- **逻辑 (地心引力):** 当现价 $P_{Final}$ 远高于基本面 $S_T$ 时，差值为负，他们做空（压低价格）；反之则抄底。他们是市场的稳定器。

##### C. $\Delta I_{Trend}$ (技术派：趋势冲浪者)

含义: 看着K线图操作的投机客（如谢恩）。他们不关心土豆值多少钱，只关心均线是否金叉。

公式:

$$\Delta I_{Trend} = k_{trend} \cdot \text{sign}(P_{Final}(t) - MA_{n}(t))$$

- $MA_n$: $n$ 周期移动平均线。
- **逻辑 (惯性):** 如果价格在均线之上，他们就推着价格继续涨。这是市场出现“惯性”的原因。

##### D. $\Delta I_{FOMO}$ (韭菜：情绪放大器)

含义: 追涨杀跌的盲从者（如刘易斯、普通村民）。他们对“价格变化的加速度”最敏感。

公式:

$$\Delta I_{FOMO} = k_{fomo} \cdot (I(t) - I(t-1))$$

- $I(t) - I(t-1)$: 上一帧的涨跌幅。
- **逻辑 (正反馈):** 刚才玩家买入导致涨了？那我也买！这会导致价格在玩家停止操作后，依然莫名其妙地暴涨一段。

### 4. 随机市场剧本 (The Scenario Engine)

为了避免模型变得机械化，系统每天（或每几小时）会随机抽取一个“剧本”。剧本本质上是一组**参数修正器 (Modifiers)**，动态调整上述 $k$ 值，从而改变NPC的性格。

#### 剧本 I：死水一潭 (Liquidity Trap)

- **叙述:** “市场交投清淡，甚至连苍蝇飞过的声音都听得见。”
- **参数特征:**
  - $k_{smart} \to \text{High}$ (极高): 任何偏离都会被瞬间抹平。
  - $k_{fomo} \to 0$: 没人跟风。
- **现象:** 玩家试图拉升价格，但价格像被焊死了一样，瞬间回调。交易充满了挫败感。

#### 剧本 II：非理性繁荣 (Irrational Exuberance)

- **叙述:** “每个人都在谈论期货，连酒吧里的醉汉都觉得自己是股神。”
- **参数特征:**
  - $k_{smart} \to 0$: 理性消失。
  - $k_{fomo} \to \text{Extreme}$ (极高): 极其微小的上涨都会引发海啸般的跟风。
- **现象:** 玩家只需买入少量货物“点火”，就能引发一场壮观的泡沫，价格脱离地心引力飞向月球。

#### 剧本 III：恐慌踩踏 (Panic Selling)

- **叙述:** “坏消息在蔓延，恐惧支配了山谷。”
- **参数特征:**
  - **不对称性:** 对下跌的敏感度 $k_{down}$ 极高，对上涨的反应 $k_{up}$ 为零。
- **现象:** 任何卖单都会引发连锁崩盘，玩家试图“护盘”买入，瞬间被抛压淹没。

#### 剧本 IV：轧空风暴 (Short Squeeze)

- **叙述:** “空头不死，多头不止。过度做空者正在被屠杀。”
- **触发条件:** 价格严重偏离基本面，且剧本被激活。
- **参数特征 (逻辑反转):**
  - $k_{smart}$ 翻转为**正数**: 原本该“做空平抑价格”的聪明钱，因为保证金不足爆仓，被迫“买入平仓”。
- **现象:** 价格明明已经贵得离谱，却因为空头爆仓而出现违反直觉的二次垂直拉升。

## 五、 做市商（系统）逻辑

1. **唯一对手方**：系统是被动接受所有交易的唯一对手方。
2. **报价**：系统基于 $P_{\text{future}}(t)$ 提供双边报价（`Bid`/`Ask`），并通过 `Spread`（价差）盈利。
3. **交割执行**：在Day 28，严格执行实物交割（发邮件 / 查库存）。

### 模块一：L2 动态订单簿 (The Living Order Book)

这是每一帧交易发生的物理战场。它不再是一个单一的价格点，而是一个基于概率分布生成的深度列表。

1. **快照生成 (Snapshot Generation)**:
   - 每一帧开始时，系统基于当前价格 $P_t$ 和市场情绪（看涨/看跌），生成背景 NPC 的挂单。
   - **看涨时**: 卖盘（Ask）稀疏，买盘（Bid）密集且激进。
   - **看跌时**: 卖盘堆积，买盘撤退。
2. **玩家注入 (Player Injection)**:
   - 玩家的**限价单 (Limit Orders)** 被物理插入到这个列表中。
   - **持久化**: 只要未成交且未撤单，玩家的单子就是列表中的一颗“钉子”，跨帧存在，直到被吃掉。

### 模块二：交易执行逻辑 (The Execution Logic)

这是玩家与市场互动的直接规则。

**场景 A：玩家作为 Taker (市价单/吃单)**

- **行为**: 玩家扔出一笔资金，要求“立即成交”。
- **逻辑**:
  1. **扫单**: 从最优价（Best Ask/Bid）开始，逐层消耗 NPC 和挂单玩家的流动性。
  2. **滑点 (Slippage)**: 如果第一层不够吃，就吃第二层、第三层。玩家最终的**平均成交价 (VWAP)** 会劣于初始看到的现价。
  3. **冲击**: 吃掉的单量转化为 $\Delta I_{Player}$，直接推高/拉低下一帧的宏观价格基准。

**场景 B：玩家作为 Maker (限价单/挂单)**

- **行为**: 玩家指定价格（例如 100g），将资金摆在盘口。
- **逻辑**:
  1. **瞬时撮合**: 如果玩家挂单价优于对手盘（例如挂 100买，市场卖一仅 99），则立即作为 Taker 吃掉 99 的单子。
  2. **入册**: 如果无法立即成交，玩家订单进入 Order Book，成为**买一**或**卖一**，也就是成为了新的**市场价格边界**。
  3. **等待**: 等待后续的“虚拟流量”来撞击。

### 模块三：虚拟流量与碰撞检测 (Virtual Flow & Collision)

这是连接宏观模型（模型四/五）与微观订单簿的桥梁。我们用**“能量流”**来模拟价格的移动。

1. **意图计算 (The Intention)**:
   - 模型四（布朗桥）+ 模型五（情绪层）计算出下一帧的**理论目标价** $P_{target}$。
   - 例如：当前价 100g，模型想跌到 98g。
2. **流量生成 (Flow Generation)**:
   - 系统计算：要让价格从 100 跌到 98，需要一股多大的**抛压 (Selling Pressure)**？
   - 这股抛压被具象化为一股**“虚拟市价卖单流”**。
3. **物理碰撞 (The Collision)**:
   - 这股虚拟卖单流开始向下俯冲，撞击买盘队列。
   - **如果撞到 NPC**: 瞬间击穿，价格下跌。
   - **如果撞到玩家 (The Wall)**:
     - 玩家挂单（例如 1000 个 @ 100g）开始消耗虚拟流量。
     - **情形一 (墙厚)**: 流量耗尽，玩家还剩 500 个。结果：**价格被死死钉在 100g**，模型预测的 98g 失败。
     - **情形二 (墙破)**: 玩家单子被吃光，流量还剩一点。结果：**价格跌穿 100g**，继续向下寻找新的平衡点。

### 模块四：反馈循环 (The Feedback Loop)

微观的博弈结果会反向重写宏观参数。

- 成交即动量:

  玩家被“吃掉”的那部分单子（无论是主动吃还是被动挂单成交），都视为真实成交量。这将计入模型五的 $\Delta I_{Player}$，意味着玩家确实吸收了市场的抛压/买压，市场情绪会因此改变（例如：大额承接导致跌不动了，市场可能反转）。

- 挂单即心理:

  玩家未成交的巨额挂单，作为可见深度，会影响 NPC 的 $\Delta I_{Smart}$（认为此处有强支撑/强阻力），从而减缓未来的虚拟流量生成速度。

## 六、 技术实现核心 (Mod兼容性)

1. **UI不暂停**：Mod的交易UI界面**必须设置**为“打开时不暂停游戏时间”，这是实现高频交易和防止作弊的前提。
2. **“心脏”：混合时间模型**：
   - **波动频率（体感）**：与**真实时间**挂钩。
     - 使用 `helper.Events.GameLoop.UpdateTicked` (每帧触发)。
     - 在内部设置一个真实时间计时器 `REAL_TIME_TICK_INTERVAL` (例如 0.7秒)。
     - 每0.7真实秒执行一次 `UpdateMarketPrices()` 函数。
   - **价格趋势（逻辑）**：与**游戏时间**挂钩。
     - 在 `UpdateMarketPrices()` 函数内部，**必须读取 `Game1.timeOfDay`** 来计算当前是游戏内的“哪一分钟”（`timeRatio`）。
     - 所有的“理想路径” (`P_path`) 和“基差” (`DaysToExpiry`) 都基于这个 `Game1.timeOfDay` 来计算。
   - **完美兼容**：此模型自动适配骷髅洞穴（游戏时间变慢 -> `P_path` 移动变慢 -> `ΔP_drift` 变小 -> 市场横盘）和时间加速Mod（游戏时间变快 -> `P_path` 移动飞快 -> `ΔP_drift` 巨大 -> 市场趋势极强）。

## 七、 配置系统

期货模块采用 JSON 配置文件驱动，支持热加载和灵活调整。配置文件位于 `StardewCapital.Core/Assets/` 目录下。

### 7.1 商品配置 (commodities_config.json)

#### 7.1.1 基础标识

| 参数 | 类型 | 示例 | 说明 |
|------|------|------|------|
| `id` | string | `"PARSNIP"` | 商品唯一标识符（大写英文） |
| `name` | string | `"防风草"` | 显示名称（中文） |
| `item_id` | string | `"24"` | 星露谷游戏内物品ID |
| `category` | string | `"vegetables"` | 商品类别：vegetables/fruits/artisan/precious_metals |

#### 7.1.2 地区价格 (region_prices)

支持多地区不同定价：

| 地区 | 说明 | 典型特征 |
|------|------|----------|
| `pelican_town` | 鹈鹕镇（默认） | 农产品丰富，价格低 |
| `calico_desert` | 卡利科沙漠 | 农产品稀缺，价格高 |
| `ginger_island` | 姜岛 | 热带作物丰富 |

每个地区包含：
- `base_price`: 基础价格
- `availability`: 可用性（none/rare/uncommon/common/abundant）

#### 7.1.3 交易设置 (trade_settings) ⭐ 核心参数

| 参数 | 类型 | 默认值 | 说明 | 实现状态 |
|------|------|--------|------|----------|
| `contract_type` | string | `"monthly"` | 合约类型：monthly/yearly/perpetual | ⚠️ 已解析，永续逻辑待完善 |
| `contract_size` | int | `100` | 合约乘数（1手=多少单位） | ✅ 已实现 |
| `tick_size` | double | `0.01` | 最小价格变动单位 | ❌ 未使用 |
| `initial_margin_ratio` | double | `0.10` | 初始保证金比例（10%） | ✅ 已实现 |
| `maintenance_margin_ratio` | double | `0.08` | 维持保证金比例（8%） | ❌ 追保逻辑未实现 |
| `price_limits.min` | double | `5` | 价格下限（跌停价） | ❌ 未实现 |
| `price_limits.max` | double | `200` | 价格上限（涨停价） | ❌ 未实现 |

**待实现功能**：
- [ ] 价格按 `tick_size` 舍入
- [ ] 追保通知与强制平仓（基于 `maintenance_margin_ratio`）
- [ ] 价格限制检查（`price_limits`）
- [ ] 永续合约特殊处理

#### 7.1.4 价格行为 (price_behavior) ⭐ GBM 核心参数

| 参数 | 类型 | 说明 | 实现状态 |
|------|------|------|----------|
| `base_volatility` | double | 基础日波动率（对应 $\sigma_{base}$） | ✅ |
| `intraday_volatility` | double | 日内波动率（布朗桥用） | ✅ |
| `volatility_clustering` | double | 波动率聚集（GARCH效应，0-1） | ✅ |
| `mean_reversion_speed` | double | 均值回归速度（对应 $\alpha_t$） | ✅ |
| `momentum_factor` | double | 动量因子（趋势延续） | ✅ |
| `jump_probability` | double | 跳跃概率（每日） | ✅ |
| `jump_magnitude` | double | 跳跃幅度 | ✅ |

#### 7.1.5 季节性 (seasonality)

| 参数 | 说明 | 实现状态 |
|------|------|----------|
| `grow_seasons` | 可种植季节列表（对应 $\lambda_s$） | ✅ |
| `off_season_multiplier` | 非当季价格乘数 | ✅ |
| `season_volatility` | 各季节波动率修正系数 | ✅ |

#### 7.1.6 供需 (supply_demand)

| 参数 | 对应文档公式 | 实现状态 |
|------|-------------|----------|
| `base_demand` | $D_{base}$ | ✅ |
| `base_supply` | $S_{base}$ | ✅ |
| `storage_cost_per_day` | $\phi$ (仓储成本) | ✅ |
| `demand_elasticity` | 需求弹性 | ⚠️ 部分使用 |

#### 7.1.7 市场结构 (market_structure)

| 参数 | 对应文档公式/概念 | 实现状态 |
|------|------------------|----------|
| `base_liquidity` | 流动性池大小 | ✅ |
| `impact_coefficient` | $\eta$ (流动性敏感度) | ✅ |
| `base_spread_ratio` | Bid-Ask 价差 | ✅ |
| `turnover_rate` | 换手率 | ⚠️ 部分使用 |

#### 7.1.8 事件敏感度 (event_sensitivity)

控制商品对不同类型新闻的敏感程度（0-1）：

| 参数 | 说明 | 典型值 |
|------|------|--------|
| `weather` | 天气敏感度 | 农作物高，贵金属低 |
| `pest` | 病虫害敏感度 | 农作物高 |
| `festival` | 节日敏感度 | 手工品高 |
| `npc_demand` | NPC需求敏感度 | 送礼品高 |

#### 7.1.9 市场关联 (correlations)

定义商品间的价格联动关系：

| 关联类型 | 说明 | 传导方向 |
|----------|------|----------|
| `input` | 原料→产品 | 蓝莓涨 → 蓝莓酒涨 |
| `output` | 产品←原料（反向） | 蓝莓酒涨 → 蓝莓需求增 |
| `substitute` | 替代品 | 防风草涨 → 土豆需求增 |

### 7.2 新闻配置 (news_config.json)

#### 7.2.1 新闻事件结构

| 参数 | 说明 | 对应文档公式 |
|------|------|-------------|
| `id` | 新闻唯一标识 | - |
| `title` / `content` | 标题/内容（支持占位符） | - |
| `severity` | 严重程度：low/medium/high/critical | 影响 $\sigma$ |
| `demand_delta` | 需求变化百分比 | $D_{news}(t)$ |
| `supply_delta` | 供给变化百分比 | $S_{news}(t)$ |
| `price_multiplier` | 即时价格乘数（用于critical） | - |
| `volatility_modifier` | 波动率修正 | $\sigma$ 调整 |
| `duration_days` | 影响持续天数 | 消化因子 |
| `is_permanent` | 是否永久影响 | 是否完全消化 |

#### 7.2.2 触发条件

```json
"trigger_conditions": {
    "season": ["Spring"],           // 季节限制
    "day_range": { "min": 5, "max": 25 },  // 日期范围
    "base_probability": 0.02        // 基础触发概率
}
```

#### 7.2.3 影响商品

```json
"affected_commodities": ["PARSNIP", "POTATO", "CAULIFLOWER"]
```
指定空数组 `[]` 表示影响所有商品。

---

## 八、 实现状态跟踪

### 8.1 已完成功能 ✅

| 模块 | 功能 | 对应文档 |
|------|------|----------|
| 价格生成 | GBM 每日结算价生成 | 模型二 |
| 价格生成 | 布朗桥日内价格生成 | 模型四 |
| 价格生成 | 持有成本模型 | 模型三 |
| 基本面 | 供需平衡价格计算 | 模型一 |
| 基本面 | 新闻事件影响（需求/供给） | $D_{news}$, $S_{news}$ |
| 基本面 | 新闻消化因子（渐进吸收） | - |
| 基本面 | 永久/临时新闻区分 | - |
| 订单簿 | L2 订单簿模拟 | 模块一 |
| 订单簿 | 市场冲击计算 | $\Delta I_{Player}$ |
| 配置 | JSON 商品配置加载 | - |
| 配置 | JSON 新闻配置加载 | - |
| 配置 | 多地区价格支持 | - |
| 关联 | 商品价格联动传导 | - |

### 8.2 部分实现 ⚠️

| 模块 | 功能 | 当前状态 | 待完善 |
|------|------|----------|--------|
| 交易 | 保证金计算 | 仅初始保证金 | 追保通知、强平 |
| 合约 | 合约类型 | 仅解析 | 永续合约特殊逻辑 |
| 市场 | NPC参与者 | 无 | 聪明钱/趋势派/韭菜 |
| 市场 | 随机剧本 | 无 | 死水/繁荣/恐慌/轧空 |

### 8.3 待实现 ❌

| 模块 | 功能 | 优先级 |
|------|------|--------|
| 交易 | 价格舍入（tick_size） | P1 |
| 交易 | 涨跌停限制（price_limits） | P1 |
| 交易 | 追加保证金通知 | P2 |
| 交易 | 强制平仓 | P2 |
| 交易 | 实物交割 | P2 |
| 交易 | 空单违约惩罚 | P3 |
| UI | 交易界面（不暂停游戏） | P1 |
| 市场 | 模型五（NPC博弈层） | P3 |
| 市场 | 随机市场剧本 | P3 |

### 8.4 配置参数与文档公式对照表

| 配置参数 | 文档公式/变量 | 位置 |
|----------|--------------|------|
| `base_price` | $P_{base}$ | 模型一 |
| `base_demand` | $D_{base}$ | 模型一 |
| `base_supply` | $S_{base}$ | 模型一 |
| `off_season_multiplier` | $\lambda_s$ | 模型一 |
| `demand_delta` | $D_{news}(t)$ | 模型一 |
| `supply_delta` | $S_{news}(t)$ | 模型一 |
| `base_volatility` | $\sigma_{base}$ | 模型二 |
| `mean_reversion_speed` | $\alpha_t$ | 模型二 |
| `storage_cost_per_day` | $\phi$ | 模型三 |
| `intraday_volatility` | $\sigma_{intra}$ | 模型四 |
| `impact_coefficient` | $\eta$ | 模型五 |

---

## 九、 文件结构

```
StardewCapital.Core/
├── Assets/
│   ├── commodities_config.json          # 商品配置
│   ├── commodities_config_documented.jsonc  # 带注释的参数说明
│   ├── news_config.json                 # 新闻配置
│   └── market_config.json               # 市场全局配置
├── Futures/
│   ├── Config/
│   │   ├── CommodityConfig.cs           # 配置数据模型
│   │   ├── CommodityConfigLoader.cs     # 商品配置加载器
│   │   ├── NewsConfigLoader.cs          # 新闻配置加载器
│   │   └── MarketConfig.cs              # 市场配置模型
│   ├── Math/
│   │   ├── GBM.cs                       # 几何布朗运动（模型二）
│   │   ├── BrownianBridge.cs            # 布朗桥（模型四）
│   │   └── CostOfCarry.cs               # 持有成本模型（模型三）
│   ├── Pricing/
│   │   ├── FundamentalEngine.cs         # 基本面引擎（模型一）
│   │   └── FuturesPriceGenerator.cs     # 价格生成器总控
│   ├── Market/
│   │   └── FuturesOrderBook.cs          # L2订单簿（模块一）
│   ├── Models/
│   │   ├── FuturesContract.cs           # 期货合约
│   │   ├── FuturesParameters.cs         # 合约参数
│   │   └── Commodity.cs                 # 商品基础模型
│   └── FuturesMarket.cs                 # 期货市场门面类
└── Time/
    └── ITimeProvider.cs                 # 时间提供者接口
```




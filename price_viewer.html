<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Capital - Price Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        select {
            padding: 12px 20px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.3s;
        }

        select:hover {
            border-color: #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .news-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .news-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .news-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            border-radius: 8px;
        }

        .news-item.positive {
            border-left-color: #48bb78;
        }

        .news-item.negative {
            border-left-color: #f56565;
        }

        .news-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .news-impact {
            font-size: 0.9em;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìà Stardew Capital Price Viewer</h1>
        <p class="subtitle">ÂèØËßÜÂåñÊúüË¥ß‰ª∑Ê†ºËµ∞ÂäøÂíåÊñ∞Èóª‰∫ã‰ª∂</p>

        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".json">
            </div>
            <select id="contractSelect" disabled>
                <option value="">ÈÄâÊã©ÊúüË¥ßÂêàÁ∫¶...</option>
            </select>
        </div>

        <div id="errorMessage"></div>
        <div id="infoSection"></div>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="news-section" id="newsSection"></div>
    </div>

    <script>
        let marketData = null;
        let chart = null;

        const fileInput = document.getElementById('fileInput');
        const contractSelect = document.getElementById('contractSelect');
        const errorMessage = document.getElementById('errorMessage');
        const infoSection = document.getElementById('infoSection');
        const newsSection = document.getElementById('newsSection');

        fileInput.addEventListener('change', handleFileSelect);
        contractSelect.addEventListener('change', handleContractSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    marketData = JSON.parse(e.target.result);
                    loadContracts();
                    errorMessage.innerHTML = '';
                } catch (error) {
                    showError('JSON Ëß£ÊûêÂ§±Ë¥•: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadContracts() {
            contractSelect.innerHTML = '<option value="">ÈÄâÊã©ÊúüË¥ßÂêàÁ∫¶...</option>';

            if (marketData.FuturesStates && marketData.FuturesStates.length > 0) {
                marketData.FuturesStates.forEach((futures, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${futures.CommodityName} (${futures.Symbol})`;
                    contractSelect.appendChild(option);
                });
                contractSelect.disabled = false;
            }
        }

        function handleContractSelect() {
            const selectedIndex = contractSelect.value;
            if (selectedIndex === '') return;

            const futures = marketData.FuturesStates[selectedIndex];
            displayMarketInfo(futures);
            displayChart(futures);
            displayNews(futures);
        }

        function displayMarketInfo(futures) {
            const stepsPerDay = futures.StepsPerDay || 0;
            const totalDays = Math.floor(futures.ShadowPrices.length / stepsPerDay);
            const avgPrice = futures.ShadowPrices.reduce((a, b) => a + b, 0) / futures.ShadowPrices.length;
            const maxPrice = Math.max(...futures.ShadowPrices);
            const minPrice = Math.min(...futures.ShadowPrices);

            infoSection.innerHTML = `
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">ÂïÜÂìÅÂêçÁß∞</div>
                        <div class="info-value">${futures.CommodityName}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">ÂêàÁ∫¶‰ª£Á†Å</div>
                        <div class="info-value">${futures.Symbol}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Â≠£ËäÇ</div>
                        <div class="info-value">${marketData.CurrentSeason} Y${marketData.CurrentYear}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">ÊÄªÂ§©Êï∞</div>
                        <div class="info-value">${totalDays}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Âπ≥Âùá‰ª∑Ê†º</div>
                        <div class="info-value">${avgPrice.toFixed(2)}g</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">‰ª∑Ê†ºÂå∫Èó¥</div>
                        <div class="info-value">${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}g</div>
                    </div>
                </div>
            `;
        }

        function displayChart(futures) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            // ÊåâÂ§©ËÅöÂêàÊï∞ÊçÆÔºàÊòæÁ§∫Êî∂Áõò‰ª∑Ôºâ
            const stepsPerDay = futures.StepsPerDay || 1;
            const dailyPrices = [];
            const labels = [];

            for (let day = 0; day < 28; day++) {
                const dayEndIndex = (day + 1) * stepsPerDay - 1;
                if (dayEndIndex < futures.ShadowPrices.length) {
                    dailyPrices.push(futures.ShadowPrices[dayEndIndex]);
                    labels.push(`Day ${day + 1}`);
                }
            }

            // Ê∑ªÂä†Âü∫Êú¨Èù¢‰ª∑ÂÄºÁ∫ø
            const fundamentalValues = futures.FundamentalValues || [];

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Êî∂Áõò‰ª∑',
                            data: dailyPrices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Âü∫Êú¨Èù¢‰ª∑ÂÄº',
                            data: fundamentalValues,
                            borderColor: '#f56565',
                            backgroundColor: 'rgba(245, 101, 101, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${futures.CommodityName} ‰ª∑Ê†ºËµ∞Âäø`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '‰ª∑Ê†º (g)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ê∏∏ÊàèÊó•Êúü'
                            }
                        }
                    }
                }
            });
        }

        function displayNews(futures) {
            const scheduledNews = futures.ScheduledNews || [];

            if (scheduledNews.length === 0) {
                newsSection.innerHTML = '<h2>üì∞ Êñ∞Èóª‰∫ã‰ª∂</h2><p style="color: #718096;">ÊöÇÊó†Êñ∞Èóª‰∫ã‰ª∂</p>';
                return;
            }

            let newsHTML = '<h2>üì∞ Êñ∞Èóª‰∫ã‰ª∂ (' + scheduledNews.length + ')</h2>';

            scheduledNews.forEach(newsEvent => {
                const event = newsEvent.Event;
                // Ê≥®ÊÑèÔºöJSON ‰ΩøÁî® snake_case Â≠óÊÆµÂêç
                const impact = event.Impact || {};
                const demandImpact = impact.demand_impact || impact.DemandImpact || 0;
                const supplyImpact = impact.supply_impact || impact.SupplyImpact || 0;
                const netImpact = demandImpact - supplyImpact;

                let impactClass = '';
                let impactIcon = 'üìä';
                if (netImpact > 100) {
                    impactClass = 'positive';
                    impactIcon = 'üìà';
                } else if (netImpact < -100) {
                    impactClass = 'negative';
                    impactIcon = 'üìâ';
                }

                const triggerTime = newsEvent.TriggerTimeRatio
                    ? ` (Áõò‰∏≠ ${(newsEvent.TriggerTimeRatio * 100).toFixed(0)}%)`
                    : ' (ÁõòÂêé)';

                newsHTML += `
                    <div class="news-item ${impactClass}">
                        <div class="news-title">${impactIcon} Day ${newsEvent.TriggerDay}${triggerTime}: ${event.Title}</div>
                        <div class="news-impact">
                            ÈúÄÊ±ÇÂΩ±Âìç: <strong>${demandImpact > 0 ? '+' : ''}${demandImpact}</strong> | 
                            ‰æõÁªôÂΩ±Âìç: <strong>${supplyImpact > 0 ? '+' : ''}${supplyImpact}</strong> | 
                            ÂáÄÂΩ±Âìç: <strong style="color: ${netImpact > 0 ? '#48bb78' : '#f56565'}">${netImpact > 0 ? '+' : ''}${netImpact.toFixed(0)}</strong>
                        </div>
                    </div>
                `;
            });

            newsSection.innerHTML = newsHTML;
        }

        function showError(message) {
            errorMessage.innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }
    </script>
</body>

</html>
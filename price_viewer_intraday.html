<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Capital - Price Viewer (å«æ—¥å†…èµ°åŠ¿)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        select {
            padding: 12px 20px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.3s;
        }

        select:hover {
            border-color: #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .intraday-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .intraday-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .intraday-controls label {
            font-weight: bold;
            color: #2d3748;
        }

        .news-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .news-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .news-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            border-radius: 8px;
        }

        .news-item.positive {
            border-left-color: #48bb78;
        }

        .news-item.negative {
            border-left-color: #f56565;
        }

        .news-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .news-impact {
            font-size: 0.9em;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“ˆ Stardew Capital Price Viewer</h1>
        <p class="subtitle">å¯è§†åŒ–æœŸè´§ä»·æ ¼èµ°åŠ¿å’Œæ–°é—»äº‹ä»¶ (å«æ—¥å†…ä»·æ ¼èµ°åŠ¿)</p>

        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".json">
            </div>
            <select id="contractSelect" disabled>
                <option value="">é€‰æ‹©æœŸè´§åˆçº¦...</option>
            </select>
        </div>

        <div id="errorMessage"></div>
        <div id="infoSection"></div>

        <!-- æ—¥æ”¶ç›˜ä»·å›¾è¡¨ -->
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>

        <!-- æ—¥å†…ä»·æ ¼èµ°åŠ¿å›¾è¡¨ -->
        <div class="intraday-section" id="intradaySection" style="display: none;">
            <div class="intraday-controls">
                <label for="daySelect">ğŸ“Š é€‰æ‹©æ—¥æœŸæŸ¥çœ‹æ—¥å†…ä»·æ ¼èµ°åŠ¿ï¼š</label>
                <select id="daySelect">
                    <option value="">è¯·å…ˆé€‰æ‹©æœŸè´§åˆçº¦</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="intradayChart"></canvas>
            </div>
        </div>

        <div class="news-section" id="newsSection"></div>
    </div>

    <script>
        let marketData = null;
        let chart = null;
        let intradayChart = null;
        let currentFutures = null;

        const fileInput = document.getElementById('fileInput');
        const contractSelect = document.getElementById('contractSelect');
        const errorMessage = document.getElementById('errorMessage');
        const infoSection = document.getElementById('infoSection');
        const newsSection = document.getElementById('newsSection');
        const daySelect = document.getElementById('daySelect');
        const intradaySection = document.getElementById('intradaySection');

        fileInput.addEventListener('change', handleFileSelect);
        contractSelect.addEventListener('change', handleContractSelect);
        daySelect.addEventListener('change', handleDaySelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    marketData = JSON.parse(e.target.result);
                    loadContracts();
                    errorMessage.innerHTML = '';
                } catch (error) {
                    showError('JSON è§£æå¤±è´¥: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadContracts() {
            contractSelect.innerHTML = '<option value="">é€‰æ‹©æœŸè´§åˆçº¦...</option>';

            if (marketData.FuturesStates && marketData.FuturesStates.length > 0) {
                marketData.FuturesStates.forEach((futures, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${futures.CommodityName} (${futures.Symbol})`;
                    contractSelect.appendChild(option);
                });
                contractSelect.disabled = false;
            }
        }

        function handleContractSelect() {
            const selectedIndex = contractSelect.value;
            if (selectedIndex === '') return;

            currentFutures = marketData.FuturesStates[selectedIndex];
            displayMarketInfo(currentFutures);
            displayChart(currentFutures);
            displayNews(currentFutures);
            initializeDaySelect(currentFutures);
        }

        function displayMarketInfo(futures) {
            const stepsPerDay = futures.StepsPerDay || 0;
            const totalDays = Math.floor(futures.ShadowPrices.length / stepsPerDay);
            const avgPrice = futures.ShadowPrices.reduce((a, b) => a + b, 0) / futures.ShadowPrices.length;
            const maxPrice = Math.max(...futures.ShadowPrices);
            const minPrice = Math.min(...futures.ShadowPrices);

            infoSection.innerHTML = `
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">å•†å“åç§°</div>
                        <div class="info-value">${futures.CommodityName}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">åˆçº¦ä»£ç </div>
                        <div class="info-value">${futures.Symbol}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">å­£èŠ‚</div>
                        <div class="info-value">${marketData.CurrentSeason} Y${marketData.CurrentYear}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">æ€»å¤©æ•°</div>
                        <div class="info-value">${totalDays}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">å¹³å‡ä»·æ ¼</div>
                        <div class="info-value">${avgPrice.toFixed(2)}g</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">ä»·æ ¼åŒºé—´</div>
                        <div class="info-value">${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}g</div>
                    </div>
                </div>
            `;
        }

        function displayChart(futures) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            // æŒ‰å¤©èšåˆæ•°æ®ï¼ˆæ˜¾ç¤ºæ”¶ç›˜ä»·ï¼‰
            const stepsPerDay = futures.StepsPerDay || 1;
            const dailyPrices = [];
            const labels = [];

            for (let day = 0; day < 28; day++) {
                const dayEndIndex = (day + 1) * stepsPerDay - 1;
                if (dayEndIndex < futures.ShadowPrices.length) {
                    dailyPrices.push(futures.ShadowPrices[dayEndIndex]);
                    labels.push(`Day ${day + 1}`);
                }
            }

            // æ·»åŠ åŸºæœ¬é¢ä»·å€¼çº¿
            const fundamentalValues = futures.FundamentalValues || [];

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: dailyPrices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'åŸºæœ¬é¢ä»·å€¼',
                            data: fundamentalValues,
                            borderColor: '#f56565',
                            backgroundColor: 'rgba(245, 101, 101, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${futures.CommodityName} ä»·æ ¼èµ°åŠ¿ (æ”¶ç›˜ä»·)`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ä»·æ ¼ (g)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ¸¸æˆæ—¥æœŸ'
                            }
                        }
                    }
                }
            });
        }

        function initializeDaySelect(futures) {
            const stepsPerDay = futures.StepsPerDay || 1;
            const totalDays = Math.floor(futures.ShadowPrices.length / stepsPerDay);

            daySelect.innerHTML = '<option value="">é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥æœŸ...</option>';

            for (let day = 0; day < Math.min(totalDays, 28); day++) {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = `Day ${day + 1}`;
                daySelect.appendChild(option);
            }

            intradaySection.style.display = 'block';
        }

        function handleDaySelect() {
            const selectedDay = parseInt(daySelect.value);
            if (isNaN(selectedDay) || !currentFutures) return;

            displayIntradayChart(currentFutures, selectedDay);
        }

        function displayIntradayChart(futures, day) {
            const ctx = document.getElementById('intradayChart').getContext('2d');
            const stepsPerDay = futures.StepsPerDay || 1;

            // æå–é€‰å®šæ—¥æœŸçš„æ‰€æœ‰é˜¶æ®µä»·æ ¼
            const startIndex = day * stepsPerDay;
            const endIndex = startIndex + stepsPerDay;
            const intradayPrices = futures.ShadowPrices.slice(startIndex, endIndex);

            // åˆ›å»ºæ—¶é—´æ ‡ç­¾
            const labels = [];
            for (let i = 0; i < intradayPrices.length; i++) {
                const progress = (i / (stepsPerDay - 1) * 100).toFixed(0);
                labels.push(`${progress}%`);
            }

            // è·å–å½“å¤©çš„æ–°é—»äº‹ä»¶ï¼ˆç›˜ä¸­ï¼‰
            const dayNews = (futures.ScheduledNews || []).filter(news =>
                news.TriggerDay === day + 1 &&
                news.TriggerTimeRatio !== undefined &&
                news.TriggerTimeRatio !== null
            );

            if (intradayChart) {
                intradayChart.destroy();
            }

            intradayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å½±å­ä»·æ ¼',
                        data: intradayPrices,
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Day ${day + 1} - ${futures.CommodityName} æ—¥å†…ä»·æ ¼èµ°åŠ¿${dayNews.length > 0 ? ` (å«${dayNews.length}ä¸ªç›˜ä¸­æ–°é—»)` : ''}`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function (context) {
                                    const index = context[0].dataIndex;
                                    const progress = (index / (stepsPerDay - 1) * 100).toFixed(1);
                                    return `äº¤æ˜“è¿›åº¦: ${progress}%`;
                                },
                                label: function (context) {
                                    return `ä»·æ ¼: ${context.parsed.y.toFixed(2)}g`;
                                },
                                afterLabel: function (context) {
                                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°é—»äº‹ä»¶åœ¨æ­¤æ—¶é—´ç‚¹
                                    const index = context.dataIndex;
                                    const newsAtPoint = dayNews.filter(news => {
                                        const stepIndex = Math.floor(news.TriggerTimeRatio * stepsPerDay);
                                        return stepIndex === index;
                                    });

                                    if (newsAtPoint.length > 0) {
                                        return newsAtPoint.map(news => `ğŸ“° ${news.Event.Title}`);
                                    }
                                    return null;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ä»·æ ¼ (g)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'äº¤æ˜“æ—¶æ®µè¿›åº¦'
                            }
                        }
                    }
                }
            });
        }

        function displayNews(futures) {
            const scheduledNews = futures.ScheduledNews || [];

            if (scheduledNews.length === 0) {
                newsSection.innerHTML = '<h2>ğŸ“° æ–°é—»äº‹ä»¶</h2><p style="color: #718096;">æš‚æ— æ–°é—»äº‹ä»¶</p>';
                return;
            }

            let newsHTML = '<h2>ğŸ“° æ–°é—»äº‹ä»¶ (' + scheduledNews.length + ')</h2>';

            scheduledNews.forEach(newsEvent => {
                const event = newsEvent.Event;
                const impact = event.Impact || {};
                const demandImpact = impact.demand_impact || impact.DemandImpact || 0;
                const supplyImpact = impact.supply_impact || impact.SupplyImpact || 0;
                const netImpact = demandImpact - supplyImpact;

                let impactClass = '';
                let impactIcon = 'ğŸ“Š';
                if (netImpact > 100) {
                    impactClass = 'positive';
                    impactIcon = 'ğŸ“ˆ';
                } else if (netImpact < -100) {
                    impactClass = 'negative';
                    impactIcon = 'ğŸ“‰';
                }

                const triggerTime = newsEvent.TriggerTimeRatio
                    ? ` (ç›˜ä¸­ ${(newsEvent.TriggerTimeRatio * 100).toFixed(0)}%)`
                    : ' (ç›˜å)';

                newsHTML += `
                    <div class="news-item ${impactClass}">
                        <div class="news-title">${impactIcon} Day ${newsEvent.TriggerDay}${triggerTime}: ${event.Title}</div>
                        <div class="news-impact">
                            éœ€æ±‚å½±å“: <strong>${demandImpact > 0 ? '+' : ''}${demandImpact}</strong> | 
                            ä¾›ç»™å½±å“: <strong>${supplyImpact > 0 ? '+' : ''}${supplyImpact}</strong> | 
                            å‡€å½±å“: <strong style="color: ${netImpact > 0 ? '#48bb78' : '#f56565'}">${netImpact > 0 ? '+' : ''}${netImpact.toFixed(0)}</strong>
                        </div>
                    </div>
                `;
            });

            newsSection.innerHTML = newsHTML;
        }

        function showError(message) {
            errorMessage.innerHTML = `<div class="error">âŒ ${message}</div>`;
        }
    </script>
</body>

</html>
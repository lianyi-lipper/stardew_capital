# Stardew Capital - 课堂演讲稿

**演讲时长**：10分钟  
**目标听众**：计算机/软件工程专业学生/教师  
**演讲目标**：展示游戏 Mod 开发中的软件工程实践与金融数学应用

---

## 开场白（1分钟）

大家好！今天我要分享的项目叫做 **Stardew Capital（星露资本）**，这是一个为《星露谷物语》开发的期货交易模拟 Mod。

**先问大家一个问题**：你们玩过《星露谷物语》吗？（停顿等待反应）这是一款温馨的农场模拟游戏，但我们要做的是——**在这个田园诗般的世界里，加入华尔街的金融血雨腥风**。

听起来很疯狂对吧？但这个项目的真正意义不在于"把游戏变复杂"，而在于它展示了**如何用工程化的方法，将复杂的数学模型整合进一个现有的软件系统**。

接下来，我会从三个角度介绍这个项目：
1. **为什么要做这样一个疯狂的项目？**（设计动机）
2. **怎么做到的？**（核心技术）
3. **学到了什么？**（工程启示）

---

## 第一部分：设计动机 - 为什么要做这个？（2分钟）

### 游戏的局限性

《星露谷物语》的经济系统非常简单：
- 种草莓 → 收获 → 卖给 NPC → 拿钱
- 价格是**固定的**，没有波动

这导致一个问题：**玩家很快就会找到最优策略，然后游戏就失去了挑战性**。

### 我们的愿景

如果引入**期货市场**会怎样？
- 价格会**实时波动**
- 玩家需要**预判市场**
- 可以**做空赚钱**（即使不种地也能赚钱）
- 但也可能**爆仓破产**

这就把一个休闲游戏变成了**金融策略游戏**。

### 技术挑战

但这带来了巨大的技术挑战：
1. **如何生成真实的价格波动？** 不能是纯随机数，要有金融逻辑
2. **如何平衡剧本与互动？** 游戏需要叙事性（预设事件），但玩家也要能影响市场
3. **如何防止作弊？** 玩家可以暂停游戏查看价格再决策

这些挑战促使我们设计了一套**非常工程化的解决方案**。

---

## 第二部分：核心技术 - 怎么做到的？（5分钟）

我会重点讲三个技术创新，它们代表了这个项目的核心价值。

### 技术亮点 1：双价格系统 - 剧本与自由意志的平衡

*（可展示架构图或公式）*

这是整个系统最核心的设计。我们把价格分成两层：

#### 影子价格（Shadow Price）- 上帝的剧本

想象一下，游戏开发者想让"夏季第15天南瓜暴涨"来讲一个故事。这个**预定的轨迹**就是影子价格。

**实现方式**：
- 季度开始时，用 **GBM（几何布朗运动）** 预生成整个赛季的价格曲线
- 存储在一个数组里：`shadowPrices[day]`

这就像是**铺好的铁轨**。

#### 撮合价格（Match Price）- 玩家的反抗

但玩家可以**反抗剧本**。比如玩家在 100g 挂了 1000 个买单，就像在铁轨上筑了一堵墙。

**关键问题**：墙和铁轨冲突了怎么办？

**我们的解决方案**：**势能差驱动流量**

```
价格差距 = 影子价格 - 撮合价格
        ↓
转化为"虚拟订单流"
        ↓
虚拟订单冲击玩家的墙
        ↓
墙够厚 → 价格卡住（玩家改变了剧本）
墙太薄 → 墙被击穿 → 价格崩盘
```

**类比**：这就像一个**水坝**
- 影子价格 = 水库的水位（不断上涨）
- 玩家的墙 = 大坝
- 势能差 = 水压
- 水压越大，大坝压力越大
- 大坝崩塌时 → **瀑布式行情**

这个设计完美解决了"既要有剧情，又要有自由度"的矛盾。

---

### 技术亮点 2：四层价格模型 - 从宏观到微观

真实的金融市场价格是**多时间尺度**叠加的结果。我们也采用了这种分层设计：

| 模型层 | 时间尺度 | 数学工具 | 作用 |
|--------|---------|---------|------|
| **基本面** | 季度级 | 季节系数 × 新闻冲击 | 定义价格锚点 |
| **GBM** | 日级 | 均值回归 + 随机游走 | 每日收盘价 |
| **布朗桥** | 10分钟级 | 引力 + 波动率微笑 | 日内平滑轨迹 |
| **NPC代理** | 帧级（毫秒） | 多智能体博弈 | 短期情绪 |

**为什么要这么复杂？**

举个例子：
- **基本面**告诉你："夏天草莓贵"
- **GBM** 让价格向基本面收敛，但有波动
- **布朗桥**保证开盘价和收盘价之间是平滑的曲线（不会瞬移）
- **NPC代理**模拟"聪明钱"和"韭菜"的博弈，让价格看起来真实

**实际效果**：
- K线图看起来和真实股票市场一模一样
- 但实际上每一帧的价格都是数学公式算出来的

---

### 技术亮点 3：非暂停UI - 突破游戏引擎限制

这个问题很有趣：**《星露谷物语》的任何菜单打开时，游戏时间都会暂停**。

**为什么这是个问题？**
- 玩家可以打开交易界面 → 仔细研究价格 → 关闭 → 等最佳时机再交易
- 这就变成了**回合制游戏**，失去了金融市场的紧张感

**我们怎么解决？**

使用 **Harmony 补丁**（字节码注入技术）修改游戏的底层逻辑：

```csharp
// 拦截游戏的"是否应该暂停时间"判断
[HarmonyPostfix]
public static void ShouldTimePass_Postfix(ref bool __result)
{
    // 检测到交易菜单打开 → 强制返回 true（不暂停）
    if (Game1.activeClickableMenu is TradingMenu)
    {
        __result = true;
    }
}
```

**效果**：
- 交易界面打开时，游戏时间继续流逝
- 价格在你眼前**实时波动**
- 你必须快速决策，模拟真实交易的压力

**这体现了软件工程的什么原则？**
- **非侵入式修改**：我们没有修改游戏源码（我们也没有），只是通过反射和补丁修改行为
- **面向切面编程（AOP）**：在不改变原有逻辑的前提下，注入新功能

---

## 第三部分：工程启示 - 学到了什么？（2分钟）

这个项目给我最大的三点启示：

### 1. 分层架构的重要性

我们严格遵守了**依赖倒置原则**：

```
Core（纯数学）不依赖任何游戏代码
    ↓
Domain（金融概念）依赖 Core
    ↓
Services（业务逻辑）依赖 Domain
    ↓
UI（界面）依赖 Services
```

**好处**：
- Core 层可以单独做单元测试（不需要启动游戏）
- 未来可以轻松扩展（加股票、期权）
- 代码职责清晰，维护容易

### 2. 用工程方法解决设计矛盾

很多时候，需求是**互相矛盾的**：
- 既要有剧情（固定轨迹），又要有自由度（玩家能影响）
- 既要真实（复杂计算），又要流畅（性能）

**解决方案**：
- **双价格系统**用"势能"概念融合了矛盾
- **预生成 + 实时叠加**化解了性能问题

**启示**：好的架构不是"选边站"，而是**找到一个更高维度的抽象**。

### 3. 数学模型 ≠ 直接套公式

项目用到了很多金融数学（GBM、布朗桥、Black-Scholes 思想），但**不是直接套公式**。

我们做了很多**游戏化适配**：
- 真实期货的时间单位是天/小时，我们改成了游戏的 10 分钟
- 真实波动率需要历史数据拟合，我们直接用配置文件调参
- 增加了"聪明钱 vs 韭菜"的 NPC 博弈，让价格更有戏剧性

**启示**：**理论模型**需要经过**工程转化**才能落地。

---

## 结尾 - 项目的意义（30秒）

Stardew Capital 表面上是一个游戏 Mod，但它实际上是：
- ✅ 一个**软件架构**的教学案例
- ✅ 一个**金融工程**的实践项目
- ✅ 一个**如何平衡需求矛盾**的设计范例

最重要的是，它证明了：**即使是"给游戏加个功能"这么简单的需求，背后也可以有深刻的工程思考**。

**谢谢大家！**

---

## 互动问答环节（如有时间）

准备以下问题的答案：

**Q1: 你们是怎么测试这个系统的？**
> A: 我们写了一个独立的 PriceSimulator 工具，可以不启动游戏就模拟整个季度的价格。输出 JSON 和图表，验证数学模型的正确性。

**Q2: 玩家会不会觉得太复杂？**
> A: 我们有难度分级。简单模式下，聪明钱力量很强，市场很稳定。困难模式下，韭菜力量强，会出现暴涨暴跌。玩家可以选择。

**Q3: 这个项目有开源吗？**
> A: 目前代码在私有仓库，但我们计划整理后开源。核心的数学引擎部分（Core 层）可以单独提取成库。

**Q4: 如果要加股票市场，需要改多少代码？**
> A: 很少。因为我们用了接口设计（ITradable），只需要：
> 1. 实现 Stock 类
> 2. 写一个 StockPriceGenerator（可以复用 GBM）
> 3. UI 层加一个 Stock 标签页
> 
> 底层的订单簿、NPC、时间系统完全不用动。

---

## 演讲技巧提示

### 时间分配检查
- 开场：1分钟 ✅
- 第一部分（动机）：2分钟 ✅
- 第二部分（技术）：5分钟 ✅
- 第三部分（启示）：2分钟 ✅
- 总计：10分钟 ✅

### 演讲节奏建议

1. **开场时要有能量**，用问题吸引注意力
2. **讲技术时放慢速度**，确保听众跟上逻辑
3. **用类比**（水坝、铁轨）帮助理解抽象概念
4. **展示代码片段**时不要逐行读，只讲核心思想
5. **结尾要有升华**，从技术细节回到工程哲学

### 可选的演示环节

如果条件允许，可以准备以下演示：

1. **播放录屏**：展示交易界面中价格实时波动的效果（30秒）
2. **展示 K 线图**：对比真实股票和游戏生成的 K 线，说明相似度
3. **展示配置文件**：现场修改 NPC 力量参数，说明可调性

### 肢体语言建议

- 讲"水坝模型"时，**用手势模拟水位上涨和大坝崩塌**
- 讲"四层模型"时，**用手在空中画层级**
- 讲到"价格实时波动"时，**模拟看盘时的紧张感**

---

## 备用素材（如超时需删减）

如果时间不够，优先删减以下内容：

- 第一部分的"游戏局限性"（直接说动机即可）
- 第二部分的"布朗桥"细节（只提公式名字即可）
- 第三部分的第3点"数学模型适配"（可合并到第2点）

如果时间富裕，可以补充：

- **展示代码架构图**（用 Mermaid 或手绘）
- **对比传统数据库驱动 vs 数学模型驱动**的设计差异
- **讨论类似的项目**（如 Eve Online 的经济系统）

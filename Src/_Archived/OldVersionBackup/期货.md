《对冲收获》Mod：完整设计总纲





#### 一、 核心概念与目标



- **目标**：在《星露谷物语》中引入一个高真实度的商品期货市场，让玩家（农场主）能够：
  1. **管理风险（套期保值）**：锁定未来农作物的售价，对抗市场波动。
  2. **方向投机（杠杆交易）**：利用保证金杠杆，对未来价格进行方向性押注。
  3. **高级套利（期现联动）**：利用期货与现货之间的价差（基差）进行套利。



#### 二、 核心游戏循环



1. **套期保值（Hedge）**：
   - **场景**：春季第1天，玩家种下1000个防风草。此时期货价格（$P_{\text{future}}$）为40g。玩家担心季末价格暴跌。
   - **操作**：玩家“卖出开仓”10手“春季防风草-28天合约”，锁定40g的卖价。
   - **结果 (Day 28)**：
     - **A. 价格暴跌**：现货价（$P_{\text{spot}}$）跌至20g。玩家现货少赚了20g/个。但期货合约盈利 (40g-20g) x 1000，完美弥补了亏损。
     - **B. 价格暴涨**：现货价（$P_{\text{spot}}$）涨至60g。玩家现货多赚了20g/个。但期货合约亏损 (40g-60g) x 1000，抵消了超额收益。
   - **最终效果**：无论价格如何，玩家的总收入都被锁定在40g/个，实现了风险管理。
2. **投机 (Speculate)**：
   - 玩家预期“害虫危机”会导致价格上涨。他只需支付10%的保证金（例如4g/个），就能“买入开仓”10手合约。如果价格如期上涨到60g，他将获得巨额杠杆回报。如果价格下跌，他可能血本无归（强制平仓）。
3. **期现套利 (Arbitrage)**：
   - 玩家发现 $P_{\text{future}}$ (40g) 远高于 $P_{\text{spot}}$ (35g) + 持有成本 (1g)。他会立刻“买入现货”（35g），同时“卖出期货”（40g），锁定4g的无风险利润。这种行为会（通过我们设计的“价格冲击”机制）反过来把价差拉回合理水平。



#### 三、 核心机制：实物交割与风险



- **合约**：标准化的（例如“春季防风草-28天合约”，1手 = 100个）。
- **保证金**：交易采用保证金制度，高杠杆与高风险并存。
- **每日结算**：根据当日收盘价结算持仓盈亏，保证金不足会收到“追保通知”，未及时补足则“强制平仓”。
- **实物交割（Day 28）**：
  - **玩家持有多单（Long）**：合约到期，系统自动通过邮件向玩家发送100个/手防风草。
  - **玩家持有空单（Short）**：合约到期，系统检查玩家库存（或指定交割箱）。
  - **空单违约**：如果玩家未能足额交付100个/手的防风草，将视为“违约”，**没收其全部保证金**作为惩罚。这是除强平外的最严厉惩罚。



#### 四、 核心引擎：双价格波动模型



这是整个Mod的心脏。我们放弃了“单一价格”或“27天固定”的简单模型，采用了一个逻辑自洽的、可防止套利的“双价格模型”。



##### A. “真实预期”引擎 (`P_path`)



1. **隐藏的最终价 (`FinalSpotPrice`)**：在春季第1天，系统会为防风草生成一个隐藏的、本季度的“预期结算价”（例如35g）。
2. **新闻事件驱动**：每天早上，系统随机生成“财经新闻”（例如“害虫危机”、“科技突破”）。这些新闻会**永久性地、累加地修改**那个 `FinalSpotPrice`（例如`+10g`或`-5g`）。
3. **“理想路径” (`P_path(t)`)**：这是价格的“灵魂”。它代表在游戏时间 $t$ 时，市场对 `FinalSpotPrice` 的“当前最佳猜测”。这个 `P_path(t)` 会在游戏时间内平滑地向着那个不断被新闻修改的 `FinalSpotPrice` 移动。



##### B. 现货市场模型 (`P_spot(t)`)



1. **作用**：这是玩家在**出货箱**和**皮埃尔商店**（买/卖）时看到的**真实价格**。
2. **Mod修改**：Mod必须强行Patch游戏，将所有原版固定价格替换为此价格。
3. **逻辑**：
   - $P_{\text{spot}}(\text{new}) = P_{\text{spot}}(\text{current}) + \Delta P_{\text{drift}}(\text{拉向 } P_{\text{path}}) + \Delta P_{\text{noise}}(\text{随机噪声})$
4. **防套利（关键！）**：皮埃尔的**买入价**必须基于此价格进行加成（Markup），例如：`P_pierre_buy = P_spot(t) * 1.5`。这彻底堵死了玩家在季末低价买入现货进行交割的套利漏洞。



##### C. 期货市场模型 (`P_future(t)`)



1. **作用**：这是玩家在你的**Mod交易UI**上看到的“期货合约”价格。
2. **逻辑**：它是一个更复杂的价格，由四种力量共同决定：
   - $P_{\text{future}}(\text{new}) = P_{\text{future}}(\text{current}) + \Delta P_{\text{drift}} + \Delta P_{\text{noise}} + \mathbf{\Delta P_{\text{basis}}} + \mathbf{\Delta P_{\text{impact}}}$
3. **四大力量**：
   - **$\Delta P_{\text{drift}}$ (趋势拉力)**：与现货市场一样，有一个拉力将其拉向“理想路径” `P_path`。
   - **$\Delta P_{\text{noise}}$ (随机噪声)**：模拟市场噪音。
   - **$\Delta P_{\text{basis}}$ (基差/持有成本)**：这是期货价格**必须**高于现货价格的原因。
     - `DaysToExpiry = 28 - Game1.dayOfMonth`
     - `Target_Basis = DaysToExpiry * CARRY_COST_PER_DAY` (例如 0.1g/天)
     - 期货的目标价 `Future_Target` 会比现货的目标价 `P_path` 高出 `Target_Basis`。
   - **$\Delta P_{\text{impact}}$ (价格冲击)**：这是**玩家行为**对市场的反作用。
     - Mod（做市商）记录自己的`SystemNetPosition`（例如玩家净买入1000手，系统净头寸-1000）。
     - `ΔP_impact = -(SystemNetPosition) * IMPACT_FACTOR`
     - 当玩家疯狂买入时，`ΔP_impact` 为正，**强行把期货价格推高**，模拟“大单吃掉流动性”。



#### 五、 做市商（系统）逻辑



1. **唯一对手方**：系统是被动接受所有交易的唯一对手方。
2. **报价**：系统基于 $P_{\text{future}}(t)$ 提供双边报价（`Bid`/`Ask`），并通过 `Spread`（价差）盈利。
3. **风险管理**：系统不主动投机，它只通过 `ΔP_impact` 机制来激励玩家（套利者）帮它把 `SystemNetPosition` 恢复到0。
4. **交割执行**：在Day 28，严格执行实物交割（发邮件 / 查库存）。



#### 六、 技术实现核心 (Mod兼容性)



1. **UI不暂停**：Mod的交易UI界面**必须设置**为“打开时不暂停游戏时间”，这是实现高频交易和防止作弊的前提。
2. **“心脏”：混合时间模型**：
   - **波动频率（体感）**：与**真实时间**挂钩。
     - 使用 `helper.Events.GameLoop.UpdateTicked` (每帧触发)。
     - 在内部设置一个真实时间计时器 `REAL_TIME_TICK_INTERVAL` (例如 0.7秒)。
     - 每0.7真实秒执行一次 `UpdateMarketPrices()` 函数。
   - **价格趋势（逻辑）**：与**游戏时间**挂钩。
     - 在 `UpdateMarketPrices()` 函数内部，**必须读取 `Game1.timeOfDay`** 来计算当前是游戏内的“哪一分钟”（`timeRatio`）。
     - 所有的“理想路径” (`P_path`) 和“基差” (`DaysToExpiry`) 都基于这个 `Game1.timeOfDay` 来计算。
   - **完美兼容**：此模型自动适配骷髅洞穴（游戏时间变慢 -> `P_path` 移动变慢 -> `ΔP_drift` 变小 -> 市场横盘）和时间加速Mod（游戏时间变快 -> `P_path` 移动飞快 -> `ΔP_drift` 巨大 -> 市场趋势极强）。
